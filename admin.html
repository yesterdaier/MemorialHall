<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±çµæ®¿ Â· ç®¡ç†åå°</title>
    <style>
        :root {
            --bg: #080808; --surface: #111; --surface2: #181818;
            --border: #2a2a2a; --gold: #cfaa6e; --gold-dim: rgba(207,170,110,0.15);
            --red: #8b0000; --text: #c0c0c0; --text-dim: #666;
            --font: "SimSun", "Songti SC", serif; --font-ui: "SimHei", "Heiti SC", sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

        /* é¡¶æ  */
        .topbar {
            background: #000; border-bottom: 2px solid var(--gold);
            padding: 16px 30px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100;
        }
        .topbar-title { font-size: 1.3rem; color: var(--gold); font-family: var(--font-ui); letter-spacing: 3px; }
        .topbar-actions { margin-left: auto; display: flex; gap: 10px; align-items: center; }

        /* GitHub é…ç½®åŒº */
        .github-config {
            background: #0a0a0a; border-bottom: 1px solid #1a1a1a;
            padding: 14px 30px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
        }
        .config-label { font-size: 0.8rem; color: #666; font-family: var(--font-ui); letter-spacing: 1px; white-space: nowrap; }
        .config-input {
            background: #111; border: 1px solid #333; color: #aaa;
            padding: 6px 12px; font-family: monospace; font-size: 0.85rem;
            outline: none; transition: border-color 0.2s;
        }
        .config-input:focus { border-color: var(--gold); color: var(--text); }
        .config-input.wide { width: 200px; }
        .config-input.token { width: 280px; }
        .config-status { font-size: 0.8rem; padding: 5px 12px; border: 1px solid #333; color: #666; font-family: var(--font-ui); }
        .config-status.ok { border-color: #2d6a2d; color: #5cb85c; background: rgba(45,106,45,0.1); }
        .config-status.err { border-color: #6a2d2d; color: #d62828; background: rgba(106,45,45,0.1); }

        /* ä¸»å¸ƒå±€ */
        .layout { display: grid; grid-template-columns: 300px 1fr; min-height: calc(100vh - 110px); }

        /* å·¦ä¾§åˆ—è¡¨ */
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-head-title { font-family: var(--font-ui); color: var(--gold); letter-spacing: 2px; font-size: 0.9rem; }
        .char-list { flex: 1; overflow-y: auto; }
        .char-item {
            padding: 14px 18px; border-bottom: 1px solid var(--border); cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 12px;
        }
        .char-item:hover { background: #1a1a1a; }
        .char-item.active { background: #1e1a10; border-left: 3px solid var(--gold); }
        .char-mini-info { flex: 1; min-width: 0; }
        .char-mini-name { font-family: var(--font-ui); font-size: 0.95rem; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .char-mini-status { font-size: 0.75rem; margin-top: 2px; color: var(--text-dim); }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .dot-honor { background: #4da6ff; } .dot-purged { background: #d62828; } .dot-normal { background: #666; }

        /* ç¼–è¾‘åŒº */
        .editor { padding: 30px 36px; overflow-y: auto; }
        .editor-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); text-align: center; gap: 12px; }
        .editor-empty-icon { font-size: 2.5rem; opacity: 0.3; }

        /* è¡¨å• */
        .form-title { font-size: 1.2rem; color: var(--gold); font-family: var(--font-ui); letter-spacing: 3px; border-bottom: 1px solid #2a2a2a; padding-bottom: 14px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
        .form-badge { font-size: 0.7rem; padding: 2px 8px; background: #1a1a1a; border: 1px solid #333; color: #666; }
        .form-sections { display: flex; flex-direction: column; gap: 24px; }
        .form-section { background: var(--surface2); border: 1px solid var(--border); }
        .section-header { background: #141414; padding: 10px 18px; font-family: var(--font-ui); font-size: 0.82rem; color: #777; letter-spacing: 2px; border-bottom: 1px solid var(--border); }
        .section-body { padding: 18px; display: flex; flex-direction: column; gap: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-label { font-size: 0.78rem; color: #777; font-family: var(--font-ui); letter-spacing: 1px; }
        .form-label span { color: #d62828; }
        .form-input, .form-select, .form-textarea {
            background: #0d0d0d; border: 1px solid #2a2a2a; color: var(--text);
            padding: 8px 12px; font-family: var(--font); font-size: 0.92rem;
            outline: none; transition: border-color 0.2s; width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--gold); }
        .form-textarea { resize: vertical; min-height: 70px; line-height: 1.7; }
        .form-select { cursor: pointer; }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-row { display: flex; gap: 8px; align-items: center; }
        input[type="color"] { width: 38px; height: 34px; border: 1px solid #333; background: none; cursor: pointer; padding: 2px; flex-shrink: 0; }
        .color-chips { display: flex; gap: 6px; flex-wrap: wrap; }
        .chip { width: 22px; height: 22px; border: 2px solid transparent; cursor: pointer; transition: 0.15s; flex-shrink: 0; }
        .chip:hover { border-color: var(--gold); transform: scale(1.2); }

        /* åŠ¨æ€åˆ—è¡¨ */
        .dyn-item {
            background: #0d0d0d; border: 1px solid #222; padding: 10px 12px;
            display: flex; gap: 8px; align-items: center;
        }
        .dyn-item input, .dyn-item select { flex: 1; }
        .btn-del { background: none; border: 1px solid #3d0505; color: #c62828; padding: 4px 8px; cursor: pointer; font-size: 0.78rem; flex-shrink: 0; transition: 0.15s; }
        .btn-del:hover { background: #3d0505; }
        .btn-add-row { background: none; border: 1px dashed #333; color: #555; padding: 8px; cursor: pointer; width: 100%; font-family: var(--font-ui); font-size: 0.82rem; transition: 0.2s; letter-spacing: 1px; }
        .btn-add-row:hover { border-color: var(--gold); color: var(--gold); }

        /* æ–‡ç«  */
        .article-block { background: #0c0c0c; border: 1px solid #222; margin-bottom: 10px; }
        .article-block-head { padding: 10px 14px; display: flex; align-items: center; gap: 8px; background: #111; border-bottom: 1px solid #1a1a1a; cursor: pointer; }
        .article-key-badge { font-size: 0.72rem; color: #666; background: #1a1a1a; border: 1px solid #2a2a2a; padding: 2px 7px; font-family: monospace; }
        .article-title-preview { flex: 1; font-size: 0.88rem; color: #aaa; }
        .article-body-fields { padding: 12px 14px; display: flex; flex-direction: column; gap: 10px; }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tags { display: flex; gap: 8px; }
        .status-tag { padding: 5px 14px; border: 1px solid #333; background: #0d0d0d; color: #555; font-size: 0.8rem; cursor: pointer; transition: 0.2s; font-family: var(--font-ui); }
        .status-tag.sel-honor { border-color: #4da6ff; color: #4da6ff; background: rgba(77,166,255,0.08); }
        .status-tag.sel-purged { border-color: #d62828; color: #d62828; background: rgba(214,40,40,0.08); }
        .status-tag.sel-normal { border-color: #888; color: #aaa; background: #1a1a1a; }

        /* æŒ‰é’® */
        .btn { padding: 9px 20px; font-family: var(--font-ui); font-size: 0.88rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; border: 1px solid; }
        .btn-gold { background: var(--gold-dim); border-color: var(--gold); color: var(--gold); }
        .btn-gold:hover { background: var(--gold); color: #000; }
        .btn-danger { background: rgba(139,0,0,0.15); border-color: #8b0000; color: #d62828; }
        .btn-danger:hover { background: #8b0000; color: #fff; }
        .btn-green { background: rgba(45,90,45,0.2); border-color: #2d6a2d; color: #5cb85c; }
        .btn-green:hover { background: #2d6a2d; color: #fff; }
        .btn-sm { padding: 6px 14px; font-size: 0.82rem; }
        .form-actions { display: flex; gap: 10px; padding-top: 6px; flex-wrap: wrap; }

        /* å‘å¸ƒå¼¹çª— */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: #111; border: 1px solid var(--gold); width: 520px; max-width: 95vw; }
        .modal-head { padding: 18px 24px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-family: var(--font-ui); color: var(--gold); letter-spacing: 2px; }
        .modal-body { padding: 24px; }
        .modal-foot { padding: 16px 24px; border-top: 1px solid #222; display: flex; justify-content: flex-end; gap: 10px; }
        .progress-bar { height: 4px; background: #1a1a1a; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gold); transition: width 0.4s; }
        .log-line { font-family: monospace; font-size: 0.82rem; color: #666; padding: 2px 0; }
        .log-line.ok { color: #5cb85c; }
        .log-line.err { color: #d62828; }
        .log-line.info { color: var(--gold); }

        /* toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: #111; border: 1px solid var(--gold); color: var(--gold); padding: 10px 20px; font-family: var(--font-ui); font-size: 0.88rem; letter-spacing: 1px; opacity: 0; transform: translateY(8px); transition: 0.3s; pointer-events: none; z-index: 9999; }
        .toast.show { opacity: 1; transform: translateY(0); }

        @media (max-width: 800px) { .layout { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- é¡¶æ  -->
<div class="topbar">
    <span style="font-size:1.5rem">ğŸ•¯ï¸</span>
    <div class="topbar-title">è‹±çµæ®¿ Â· ç®¡ç†åå°</div>
    <div class="topbar-actions">
        <button class="btn btn-green btn-sm" onclick="openPublishModal()">ğŸš€ å‘å¸ƒåˆ° GitHub</button>
        <a href="./index.html" target="_blank" class="btn btn-gold btn-sm" style="text-decoration:none">ğŸ‘ é¢„è§ˆç½‘ç«™</a>
    </div>
</div>

<!-- GitHub é…ç½® -->
<div class="github-config">
    <span class="config-label">ğŸ”— GitHub é…ç½®</span>
    <span class="config-label">ç”¨æˆ·å:</span>
    <input class="config-input wide" id="cfg_user" placeholder="ä½ çš„GitHubç”¨æˆ·å" oninput="saveConfig()">
    <span class="config-label">ä»“åº“å:</span>
    <input class="config-input wide" id="cfg_repo" placeholder="ä»“åº“åç§°" oninput="saveConfig()">
    <span class="config-label">åˆ†æ”¯:</span>
    <input class="config-input" id="cfg_branch" value="main" style="width:80px" oninput="saveConfig()">
    <span class="config-label">Token:</span>
    <input class="config-input token" id="cfg_token" type="password" placeholder="ghp_xxxx (Fine-grained Token)" oninput="saveConfig()">
    <button class="btn btn-gold btn-sm" onclick="testGitHub()">éªŒè¯è¿æ¥</button>
    <span class="config-status" id="configStatus">æœªéªŒè¯</span>
</div>

<!-- ä¸»å¸ƒå±€ -->
<div class="layout">
    <div class="sidebar">
        <div class="sidebar-head">
            <div class="sidebar-head-title">å…¥ æ®¿ è‹± çµ</div>
            <button class="btn btn-gold btn-sm" onclick="addChar()">ï¼‹ æ–°å¢</button>
        </div>
        <div class="char-list" id="charList"></div>
    </div>
    <div class="editor" id="editor">
        <div class="editor-empty">
            <div class="editor-empty-icon">âš±ï¸</div>
            <div style="font-size:0.88rem;letter-spacing:2px;line-height:2">é€‰æ‹©å·¦ä¾§äººç‰©å¼€å§‹ç¼–è¾‘<br>æˆ–ç‚¹å‡»ã€Œæ–°å¢ã€æ·»åŠ æ–°å…¥æ®¿è€…</div>
        </div>
    </div>
</div>

<!-- å‘å¸ƒå¼¹çª— -->
<div class="modal-overlay" id="publishModal">
    <div class="modal">
        <div class="modal-head">
            <div class="modal-title">ğŸš€ å‘å¸ƒåˆ° GitHub Pages</div>
            <button onclick="closeModal()" style="background:none;border:none;color:#666;cursor:pointer;font-size:1.2rem">âœ•</button>
        </div>
        <div class="modal-body">
            <div style="font-size:0.88rem;color:#888;margin-bottom:16px;line-height:1.8">
                æ­¤æ“ä½œå°†æŠŠå½“å‰ç¼–è¾‘çš„æ•°æ® <code style="color:var(--gold)">data.json</code> æ¨é€åˆ°ä½ çš„ GitHub ä»“åº“ï¼ŒGitHub Actions å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²ç½‘ç«™ã€‚
            </div>
            <div class="form-group">
                <label class="form-label">æäº¤è¯´æ˜ï¼ˆå¯é€‰ï¼‰</label>
                <input class="form-input" id="commitMsg" value="æ›´æ–°è‹±çµæ®¿äººç‰©æ•°æ®" placeholder="æœ¬æ¬¡æ›´æ–°è¯´æ˜">
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div id="publishLog" style="max-height:180px;overflow-y:auto"></div>
        </div>
        <div class="modal-foot">
            <button class="btn btn-danger btn-sm" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-green" id="publishBtn" onclick="doPublish()">ç¡®è®¤å‘å¸ƒ</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===================== æ•°æ® =====================
let characters = [];
let currentId = null;

// ===================== é…ç½®å­˜å‚¨ =====================
function saveConfig() {
    localStorage.setItem('gh_user', document.getElementById('cfg_user').value);
    localStorage.setItem('gh_repo', document.getElementById('cfg_repo').value);
    localStorage.setItem('gh_branch', document.getElementById('cfg_branch').value);
    localStorage.setItem('gh_token', document.getElementById('cfg_token').value);
}
function loadConfig() {
    document.getElementById('cfg_user').value = localStorage.getItem('gh_user') || '';
    document.getElementById('cfg_repo').value = localStorage.getItem('gh_repo') || '';
    document.getElementById('cfg_branch').value = localStorage.getItem('gh_branch') || 'main';
    document.getElementById('cfg_token').value = localStorage.getItem('gh_token') || '';
}
function getCfg() {
    return {
        user: document.getElementById('cfg_user').value.trim(),
        repo: document.getElementById('cfg_repo').value.trim(),
        branch: document.getElementById('cfg_branch').value.trim() || 'main',
        token: document.getElementById('cfg_token').value.trim()
    };
}

// ===================== éªŒè¯ GitHub =====================
async function testGitHub() {
    const { user, repo, token } = getCfg();
    const el = document.getElementById('configStatus');
    if (!user || !repo || !token) { el.className = 'config-status err'; el.textContent = 'ä¿¡æ¯ä¸å®Œæ•´'; return; }
    el.className = 'config-status'; el.textContent = 'éªŒè¯ä¸­...';
    try {
        const res = await fetch(`https://api.github.com/repos/${user}/${repo}`, {
            headers: { Authorization: `Bearer ${token}`, Accept: 'application/vnd.github+json' }
        });
        if (res.ok) { el.className = 'config-status ok'; el.textContent = 'âœ“ è¿æ¥æˆåŠŸ'; }
        else { el.className = 'config-status err'; el.textContent = `âœ— é”™è¯¯ ${res.status}`; }
    } catch(e) { el.className = 'config-status err'; el.textContent = 'âœ— ç½‘ç»œé”™è¯¯'; }
}

// ===================== å‘å¸ƒåˆ° GitHub =====================
function openPublishModal() {
    if (currentId) readForm(); // å…ˆä¿å­˜å½“å‰ç¼–è¾‘
    document.getElementById('publishModal').classList.add('show');
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('publishLog').innerHTML = '';
    document.getElementById('publishBtn').disabled = false;
}
function closeModal() { document.getElementById('publishModal').classList.remove('show'); }

function addLog(msg, type = '') {
    const div = document.createElement('div');
    div.className = 'log-line ' + type;
    div.textContent = msg;
    document.getElementById('publishLog').appendChild(div);
    div.scrollIntoView();
}
function setProgress(pct) { document.getElementById('progressFill').style.width = pct + '%'; }

async function doPublish() {
    const { user, repo, branch, token } = getCfg();
    if (!user || !repo || !token) { showToast('è¯·å…ˆå¡«å†™ GitHub é…ç½®å¹¶éªŒè¯'); return; }

    document.getElementById('publishBtn').disabled = true;
    document.getElementById('publishLog').innerHTML = '';
    setProgress(10);

    const commitMsg = document.getElementById('commitMsg').value || 'æ›´æ–°è‹±çµæ®¿äººç‰©æ•°æ®';
    const content = JSON.stringify({ siteTitle: 'ç´ è‰è‹±çµæ®¿', footer: 'Â© 2026 é•¿å´ç´ ä¸–çˆ±ä¸åæ§½å§ç¾¤ / æ°´ç”µç«™å®£ä¼ éƒ¨ / ä¹Œæ€è—é’å¹´èŒ¶è¯ä¼š', characters }, null, 2);
    const encoded = btoa(unescape(encodeURIComponent(content)));

    addLog('â–¶ è¿æ¥ GitHub API...', 'info');
    setProgress(20);

    try {
        // è·å–å½“å‰æ–‡ä»¶çš„ shaï¼ˆæ›´æ–°æ—¶éœ€è¦ï¼‰
        const path = 'data.json';
        const fileUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
        const headers = { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' };

        let sha = null;
        addLog('â–¶ è·å–ç°æœ‰æ–‡ä»¶ä¿¡æ¯...', 'info');
        const existing = await fetch(fileUrl + `?ref=${branch}`, { headers });
        if (existing.ok) {
            const data = await existing.json();
            sha = data.sha;
            addLog('âœ“ æ‰¾åˆ°å·²æœ‰ data.jsonï¼Œå°†æ‰§è¡Œæ›´æ–°', 'ok');
        } else if (existing.status === 404) {
            addLog('âœ“ data.json ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶', 'ok');
        } else {
            throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${existing.status}`);
        }
        setProgress(50);

        addLog('â–¶ æ¨é€æ•°æ®åˆ°ä»“åº“...', 'info');
        const body = { message: commitMsg, content: encoded, branch };
        if (sha) body.sha = sha;

        const putRes = await fetch(fileUrl, { method: 'PUT', headers, body: JSON.stringify(body) });
        if (!putRes.ok) {
            const err = await putRes.json();
            throw new Error(err.message || `æ¨é€å¤±è´¥: ${putRes.status}`);
        }
        setProgress(85);
        addLog('âœ“ data.json å·²æ¨é€åˆ° GitHubï¼', 'ok');
        addLog('â–¶ GitHub Actions å¼€å§‹è‡ªåŠ¨éƒ¨ç½²...', 'info');
        setProgress(100);

        const pageUrl = `https://${user}.github.io/${repo}/`;
        addLog(`âœ“ éƒ¨ç½²å°†åœ¨çº¦ 1-2 åˆ†é’Ÿå†…å®Œæˆ`, 'ok');
        addLog(`  ç½‘ç«™åœ°å€: ${pageUrl}`, 'ok');

        document.getElementById('publishBtn').textContent = 'âœ“ å·²å‘å¸ƒ';
        showToast('âœ“ å‘å¸ƒæˆåŠŸï¼çº¦ 1-2 åˆ†é’Ÿåç”Ÿæ•ˆ');
    } catch(e) {
        addLog('âœ— é”™è¯¯: ' + e.message, 'err');
        document.getElementById('publishBtn').disabled = false;
        setProgress(0);
    }
}

// ===================== æ¸²æŸ“åˆ—è¡¨ =====================
function renderList() {
    document.getElementById('charList').innerHTML = characters.map(c => `
        <div class="char-item ${c.id === currentId ? 'active' : ''}" onclick="selectChar('${c.id}')">
            <div class="char-mini-info">
                <div class="char-mini-name">${c.name}</div>
                <div class="char-mini-status">${c.statusText || 'ï¼ˆæ— çŠ¶æ€æè¿°ï¼‰'}</div>
            </div>
            <div class="status-dot ${c.status === 'honor' ? 'dot-honor' : c.status === 'purged' ? 'dot-purged' : 'dot-normal'}"></div>
        </div>`
    ).join('');
}

// ===================== é€‰æ‹©äººç‰© =====================
function selectChar(id) {
    if (currentId) readForm(); // ä¿å­˜ä¸Šä¸€ä¸ª
    currentId = id;
    renderList();
    renderEditor();
}

// ===================== æ–°å¢äººç‰© =====================
function addChar() {
    const id = 'char_' + Date.now();
    characters.push({
        id, name: 'æ–°å…¥æ®¿è‹±çµ', status: 'normal', statusText: '', imagePath: '',
        deathDate: new Date().toISOString().split('T')[0], deathDateLabel: 'ç¦»å¼€æˆ‘ä»¬',
        bgColorFrom: '#1a2a3a', borderColor: '#4da6ff',
        coupletLeft: 'æ­¤å¤„å¡«å†™å·¦è”', coupletRight: 'æ­¤å¤„å¡«å†™å³è”',
        hallTitle: 'è‹±çµåŒå¿—çºªå¿µå ‚', hallSubtitle: '', hasStamp: false, stampText: '',
        funeralCommittee: '',
        banners: [{ text: 'æ¨ªå¹…æ–‡å­—', style: 'im-style', articleKey: 'main' }],
        sidebarNav: [{ tag: 'æ‚¼è¯', label: 'æ­£æ–‡', articleKey: 'main', style: '' }],
        articles: [{ key: 'main', title: 'æ‚¼å¿µæ–‡ç« ', meta: 'æ²»ä¸§å§”å‘˜ä¼š', body: '<p>åœ¨æ­¤å¡«å†™æ­£æ–‡å†…å®¹ã€‚</p>' }]
    });
    selectChar(id);
}

// ===================== æ¸²æŸ“ç¼–è¾‘å™¨ =====================
function renderEditor() {
    const c = characters.find(x => x.id === currentId);
    if (!c) return;

    const colorPresets = [
        ['#4da6ff','è“'],['#d62828','çº¢'],['#cfaa6e','é‡‘'],
        ['#5cb85c','ç»¿'],['#a64dff','ç´«'],['#ff8c00','æ©™']
    ];
    const bgPresets = [
        ['#1a2a3a','è“'],['#1a0505','çº¢'],['#1a1505','é‡‘'],
        ['#051505','ç»¿'],['#1a051a','ç´«'],['#1a1005','æ©™']
    ];

    document.getElementById('editor').innerHTML = `
        <div class="form-title">
            ç¼–è¾‘è‹±çµæ¡£æ¡ˆ
            <span class="form-badge">ID: ${c.id}</span>
        </div>
        <div class="form-sections">

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-section">
                <div class="section-header">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                <div class="section-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">è‹±çµåç§° <span>*</span></label>
                            <input class="form-input" id="f_name" value="${e(c.name)}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">çºªå¿µå ‚æ ‡é¢˜</label>
                            <input class="form-input" id="f_hallTitle" value="${e(c.hallTitle)}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">çŠ¶æ€ç±»å‹</label>
                            <div class="status-tags">
                                <div class="status-tag ${c.status==='honor'?'sel-honor':''}" onclick="setStatus('honor',this)">å…‰è£éšé€€</div>
                                <div class="status-tag ${c.status==='purged'?'sel-purged':''}" onclick="setStatus('purged',this)">æ°¸ä¹…æ’¤é”€</div>
                                <div class="status-tag ${c.status==='normal'?'sel-normal':''}" onclick="setStatus('normal',this)">æ­£å¸¸çºªå¿µ</div>
                            </div>
                            <input type="hidden" id="f_status" value="${c.status}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">çŠ¶æ€è¯´æ˜ï¼ˆè‹±çµæ®¿é¦–é¡µæ˜¾ç¤ºï¼‰</label>
                            <input class="form-input" id="f_statusText" value="${e(c.statusText)}" placeholder="å¦‚ï¼šå…‰è£éšé€€ Â· å›å½’ç°å®">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">çºªå¿µå ‚å‰¯æ ‡é¢˜</label>
                            <input class="form-input" id="f_hallSubtitle" value="${e(c.hallSubtitle)}" placeholder="å¦‚ï¼šè‡´æˆ‘ä»¬ç»ˆå°†é€å»çš„æ—¶å…‰">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å°ç« </label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#888;cursor:pointer;white-space:nowrap">
                                    <input type="checkbox" id="f_hasStamp" ${c.hasStamp?'checked':''} onchange="document.getElementById('f_stampText').disabled=!this.checked"> æ˜¾ç¤ºå°ç« 
                                </label>
                                <input class="form-input" id="f_stampText" value="${e(c.stampText)}" placeholder="å°ç« æ–‡å­—" ${c.hasStamp?'':'disabled'} style="flex:1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤´åƒä¸æ—¶é—´ -->
            <div class="form-section">
                <div class="section-header">ğŸ–¼ å¤´åƒä¸è®¡æ—¶å™¨</div>
                <div class="section-body">
                    <div class="form-group full">
                        <label class="form-label">å¤´åƒè·¯å¾„ï¼ˆåŒç›®å½• images/ æ–‡ä»¶å¤¹æˆ–ç½‘ç»œURLï¼‰</label>
                        <input class="form-input" id="f_imagePath" value="${e(c.imagePath)}" placeholder="images/xxx.jpg">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç¦»å¼€æ—¥æœŸ <span>*</span></label>
                            <input type="date" class="form-input" id="f_deathDate" value="${c.deathDate}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è®¡æ—¶å™¨æ ‡ç­¾æ–‡å­—</label>
                            <input class="form-input" id="f_deathDateLabel" value="${e(c.deathDateLabel)}" placeholder="å¦‚ï¼šIm å…‰è£éšé€€">
                        </div>
                    </div>
                </div>
            </div>

            <!-- è§†è§‰ä¸»é¢˜ -->
            <div class="form-section">
                <div class="section-header">ğŸ¨ è§†è§‰ä¸»é¢˜</div>
                <div class="section-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èƒŒæ™¯ä¸»è‰²è°ƒï¼ˆæ¸å˜èµ·ç‚¹ï¼‰</label>
                            <div class="color-row">
                                <input type="color" id="f_bgColorFrom" value="${c.bgColorFrom}" oninput="syncColorText('f_bgColorFrom','bgText')">
                                <input class="form-input" id="bgText" value="${c.bgColorFrom}" oninput="document.getElementById('f_bgColorFrom').value=this.value" style="flex:1">
                            </div>
                            <div class="color-chips" style="margin-top:8px">
                                ${bgPresets.map(([v,n])=>`<div class="chip" style="background:${v}" title="${n}" onclick="setColor('f_bgColorFrom','bgText','${v}')"></div>`).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¼ºè°ƒè‰²ï¼ˆè¾¹æ¡†/æŒ½è”/æ–‡ç« æ ‡é¢˜ï¼‰</label>
                            <div class="color-row">
                                <input type="color" id="f_borderColor" value="${c.borderColor}" oninput="syncColorText('f_borderColor','bcText')">
                                <input class="form-input" id="bcText" value="${c.borderColor}" oninput="document.getElementById('f_borderColor').value=this.value" style="flex:1">
                            </div>
                            <div class="color-chips" style="margin-top:8px">
                                ${colorPresets.map(([v,n])=>`<div class="chip" style="background:${v}" title="${n}" onclick="setColor('f_borderColor','bcText','${v}')"></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŒ½è” -->
            <div class="form-section">
                <div class="section-header">ğŸ® æŒ½è”ï¼ˆæ°´æ™¶æ£ºä¸¤ä¾§ç«–æ’æ–‡å­—ï¼‰</div>
                <div class="section-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">å·¦è”</label>
                            <input class="form-input" id="f_coupletLeft" value="${e(c.coupletLeft)}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å³è”</label>
                            <input class="form-input" id="f_coupletRight" value="${e(c.coupletRight)}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨ªå¹… -->
            <div class="form-section">
                <div class="section-header">ğŸ“¢ é€šå‘Šæ¨ªå¹…ï¼ˆçºªå¿µå ‚å†…ï¼Œå¯å¤šæ¡ï¼‰</div>
                <div class="section-body">
                    <div id="bannerList">
                        ${c.banners.map(b=>`
                        <div class="dyn-item">
                            <input class="form-input banner-text" value="${e(b.text)}" placeholder="æ¨ªå¹…æ–‡å­—">
                            <select class="form-select banner-style" style="width:130px;flex:none">
                                <option value="im-style" ${b.style==='im-style'?'selected':''}>è“è‰²</option>
                                <option value="denied" ${b.style==='denied'?'selected':''}>ç°è‰²åˆ’çº¿</option>
                                <option value="critical" ${b.style==='critical'?'selected':''}>çº¢è‰²è­¦å‘Š</option>
                                <option value="" ${b.style===''?'selected':''}>æ— æ ·å¼</option>
                            </select>
                            <input class="form-input banner-key" value="${e(b.articleKey)}" placeholder="æ–‡ç« key" style="width:100px;flex:none">
                            <button class="btn-del" onclick="this.closest('.dyn-item').remove()">âœ•</button>
                        </div>`).join('')}
                    </div>
                    <button class="btn-add-row" onclick="addBanner()">ï¼‹ æ·»åŠ æ¨ªå¹…</button>
                </div>
            </div>

            <!-- ä¾§è¾¹å¯¼èˆª -->
            <div class="form-section">
                <div class="section-header">ğŸ“‘ å³ä¾§å¯¼èˆªåˆ—è¡¨ï¼ˆã€Œæ–‡ç« keyã€éœ€ä¸ä¸‹æ–¹æ–‡ç« å¯¹åº”ï¼‰</div>
                <div class="section-body">
                    <div id="navList">
                        ${c.sidebarNav.map(n=>`
                        <div class="dyn-item">
                            <input class="form-input nav-tag" value="${e(n.tag)}" placeholder="æ ‡ç­¾" style="width:80px;flex:none">
                            <input class="form-input nav-label" value="${e(n.label)}" placeholder="æ˜¾ç¤ºæ–‡å­—">
                            <input class="form-input nav-key" value="${e(n.articleKey)}" placeholder="æ–‡ç« key" style="width:100px;flex:none">
                            <button class="btn-del" onclick="this.closest('.dyn-item').remove()">âœ•</button>
                        </div>`).join('')}
                    </div>
                    <button class="btn-add-row" onclick="addNav()">ï¼‹ æ·»åŠ å¯¼èˆªé¡¹</button>
                </div>
            </div>

            <!-- æ²»ä¸§å§”å‘˜ä¼š -->
            <div class="form-section">
                <div class="section-header">ğŸ‘¥ æ²»ä¸§å§”å‘˜ä¼šï¼ˆé€‰å¡«ï¼Œæ”¯æŒHTMLï¼‰</div>
                <div class="section-body">
                    <textarea class="form-textarea" id="f_funeralCommittee" style="min-height:55px">${e(c.funeralCommittee)}</textarea>
                </div>
            </div>

            <!-- æ–‡ç« å†…å®¹ -->
            <div class="form-section">
                <div class="section-header">ğŸ“° æ–‡ç« å†…å®¹ï¼ˆæ”¯æŒHTMLï¼Œ&lt;p&gt;æ ‡ç­¾æ¢æ®µè½ï¼‰</div>
                <div class="section-body">
                    <div style="font-size:0.78rem;color:#555;margin-bottom:8px">æ¯ç¯‡æ–‡ç« çš„ã€Œkeyã€æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œæ¨ªå¹…å’Œå¯¼èˆªé€šè¿‡ key å…³è”æ–‡ç« </div>
                    <div id="articleList">
                        ${c.articles.map((a,i)=>renderArticle(a,i)).join('')}
                    </div>
                    <button class="btn-add-row" onclick="addArticle()">ï¼‹ æ·»åŠ æ–‡ç« </button>
                </div>
            </div>

            <!-- æ“ä½œ -->
            <div class="form-actions">
                <button class="btn btn-gold" onclick="saveAndRefresh()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-danger" onclick="deleteChar('${c.id}')" style="margin-left:auto">ğŸ—‘ ç§»é™¤æ­¤è‹±çµ</button>
            </div>
        </div>`;
}

function renderArticle(a, i) {
    return `<div class="article-block">
        <div class="article-block-head" onclick="toggleArticle(this)">
            <span class="article-key-badge">key: ${e(a.key)||'(æœªå¡«)'}</span>
            <span class="article-title-preview">${e(a.title)||'(æœªå‘½å)'}</span>
            <span style="color:#555;font-size:0.8rem;flex-shrink:0">â–¼ å±•å¼€/æŠ˜å </span>
        </div>
        <div class="article-body-fields">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">æ–‡ç«  keyï¼ˆè‹±æ–‡ï¼Œå”¯ä¸€ï¼‰<span>*</span></label>
                    <input class="form-input art-key" value="${e(a.key)}" placeholder="å¦‚ï¼šeditorial" oninput="this.closest('.article-block').querySelector('.article-key-badge').textContent='key: '+this.value">
                </div>
                <div class="form-group">
                    <label class="form-label">æ–‡ç« æ ‡é¢˜</label>
                    <input class="form-input art-title" value="${e(a.title)}" oninput="this.closest('.article-block').querySelector('.article-title-preview').textContent=this.value">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">æ¥æº/æ—¥æœŸï¼ˆmetaï¼‰</label>
                <input class="form-input art-meta" value="${e(a.meta)}" placeholder="å¦‚ï¼šæ²»ä¸§å§”å‘˜ä¼š | 2025å¹´12æœˆ">
            </div>
            <div class="form-group">
                <label class="form-label">æ­£æ–‡ï¼ˆHTMLæ ¼å¼ï¼‰</label>
                <textarea class="form-textarea art-body" style="min-height:150px;font-family:monospace;font-size:0.82rem">${e(a.body)}</textarea>
            </div>
            <div style="text-align:right">
                <button class="btn btn-danger btn-sm" onclick="this.closest('.article-block').remove()">åˆ é™¤æ­¤æ–‡ç« </button>
            </div>
        </div>
    </div>`;
}

function toggleArticle(head) {
    const fields = head.nextElementSibling;
    fields.style.display = fields.style.display === 'none' ? '' : 'none';
}

// ===================== è¯»å–è¡¨å• =====================
function readForm() {
    const c = characters.find(x => x.id === currentId);
    if (!c) return;
    const v = id => { const el = document.getElementById(id); return el ? el.value : ''; };
    c.name = v('f_name');
    c.status = v('f_status');
    c.statusText = v('f_statusText');
    c.imagePath = v('f_imagePath');
    c.deathDate = v('f_deathDate');
    c.deathDateLabel = v('f_deathDateLabel');
    c.bgColorFrom = document.getElementById('f_bgColorFrom')?.value || c.bgColorFrom;
    c.borderColor = document.getElementById('f_borderColor')?.value || c.borderColor;
    c.coupletLeft = v('f_coupletLeft');
    c.coupletRight = v('f_coupletRight');
    c.hallTitle = v('f_hallTitle');
    c.hallSubtitle = v('f_hallSubtitle');
    c.hasStamp = document.getElementById('f_hasStamp')?.checked || false;
    c.stampText = v('f_stampText');
    c.funeralCommittee = v('f_funeralCommittee');

    c.banners = [...document.querySelectorAll('.banner-text')].map((el, i) => ({
        text: el.value,
        style: document.querySelectorAll('.banner-style')[i]?.value || '',
        articleKey: document.querySelectorAll('.banner-key')[i]?.value || ''
    }));
    c.sidebarNav = [...document.querySelectorAll('.nav-tag')].map((el, i) => ({
        tag: el.value,
        label: document.querySelectorAll('.nav-label')[i]?.value || '',
        articleKey: document.querySelectorAll('.nav-key')[i]?.value || '',
        style: ''
    }));
    c.articles = [...document.querySelectorAll('.article-block')].map(block => ({
        key: block.querySelector('.art-key')?.value || '',
        title: block.querySelector('.art-title')?.value || '',
        meta: block.querySelector('.art-meta')?.value || '',
        body: block.querySelector('.art-body')?.value || ''
    }));
}

function saveAndRefresh() {
    readForm();
    renderList();
    showToast('âœ“ å·²ä¿å­˜ï¼ˆè®°å¾—ç‚¹ã€Œå‘å¸ƒåˆ° GitHubã€åŒæ­¥åˆ°ç½‘ç«™ï¼‰');
}

// ===================== è¾…åŠ© =====================
function e(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function setStatus(val, el) {
    document.getElementById('f_status').value = val;
    document.querySelectorAll('.status-tag').forEach(t => t.className = 'status-tag');
    if (val === 'honor') el.classList.add('sel-honor');
    else if (val === 'purged') el.classList.add('sel-purged');
    else el.classList.add('sel-normal');
}

function syncColorText(colorId, textId) {
    document.getElementById(textId).value = document.getElementById(colorId).value;
}
function setColor(colorId, textId, val) {
    document.getElementById(colorId).value = val;
    document.getElementById(textId).value = val;
}

function addBanner() {
    const list = document.getElementById('bannerList');
    const div = document.createElement('div');
    div.className = 'dyn-item';
    div.innerHTML = `<input class="form-input banner-text" value="" placeholder="æ¨ªå¹…æ–‡å­—"><select class="form-select banner-style" style="width:130px;flex:none"><option value="im-style">è“è‰²</option><option value="denied">ç°è‰²åˆ’çº¿</option><option value="critical">çº¢è‰²è­¦å‘Š</option><option value="">æ— æ ·å¼</option></select><input class="form-input banner-key" value="" placeholder="æ–‡ç« key" style="width:100px;flex:none"><button class="btn-del" onclick="this.closest('.dyn-item').remove()">âœ•</button>`;
    list.appendChild(div);
}
function addNav() {
    const list = document.getElementById('navList');
    const div = document.createElement('div');
    div.className = 'dyn-item';
    div.innerHTML = `<input class="form-input nav-tag" value="" placeholder="æ ‡ç­¾" style="width:80px;flex:none"><input class="form-input nav-label" value="" placeholder="æ˜¾ç¤ºæ–‡å­—"><input class="form-input nav-key" value="" placeholder="æ–‡ç« key" style="width:100px;flex:none"><button class="btn-del" onclick="this.closest('.dyn-item').remove()">âœ•</button>`;
    list.appendChild(div);
}
function addArticle() {
    const list = document.getElementById('articleList');
    const div = document.createElement('div');
    div.innerHTML = renderArticle({ key: 'new_' + Date.now(), title: 'æ–°æ–‡ç« ', meta: '', body: '<p>æ­£æ–‡å†…å®¹ã€‚</p>' }, Date.now());
    list.appendChild(div.firstElementChild);
}

function deleteChar(id) {
    if (!confirm('ç¡®è®¤å°†æ­¤è‹±çµä»æ®¿ä¸­ç§»é™¤ï¼Ÿ')) return;
    characters = characters.filter(c => c.id !== id);
    currentId = null;
    renderList();
    document.getElementById('editor').innerHTML = `<div class="editor-empty"><div class="editor-empty-icon">âš±ï¸</div><div style="font-size:0.88rem;letter-spacing:2px">äººç‰©å·²åˆ é™¤</div></div>`;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2800);
}

// ===================== åˆå§‹åŒ–ï¼šä» data.json åŠ è½½ =====================
async function init() {
    loadConfig();
    try {
        const res = await fetch('./data.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            characters = data.characters || [];
            showToast('âœ“ å·²ä» data.json åŠ è½½ç°æœ‰æ•°æ®');
        }
    } catch(e) {
        // ä½¿ç”¨ç©ºæ•°æ®ï¼Œé™é»˜å¤„ç†
    }
    renderList();
}

init();
</script>
</body>
</html>
